@model eGoatDDD.Application.Goats.Commands.CreateGoatCommand
@using eGoatDDD.Application.Breeds.Models
@using eGoatDDD.Application.Colors.Models
@using eGoatDDD.Application.Goats.Models


@{
    ViewData["Title"] = "Create";
}

<h2>Create</h2>
<hr />
<form asp-action="Create">
    <div class="row">
        <div asp-validation-summary="All" class="text-danger"></div>
    </div>
    <div class="row">
        <div class="col col-lg-4 col-md-4 col-sm-6 col-12">
            <h4>Details</h4>
            <div class="row">
                <div class="col col-12 code"><div class="error small font-italic alert alert-danger d-none text-align-center m-auto"></div></div>
                <div class="col col-6">
                    <div class="form-group">
                        <label class="small">Color</label>
                        <select class="form-control" data-val-required="The field is required." data-val="true" name="ColorId" id="ColorId">
                            <option value="0" selected="selected">
                                Tag color
                            </option>
                            @foreach (ColorDto item in (List
                          <ColorDto>
                              )ViewData["Colors"])
                            {
                                <option value="@item.Id"> @item.Name</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col col-6">
                    <div class="form-group">
                        <label class="small" asp-for="Code">Code</label>
                        <input asp-for="Code" required class="form-control" placeholder="Code" id="Code" />
                        <span asp-validation-for="Code" class="text-danger"></span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col col-6">
                    <div class="form-group">
                        <label class="small d-block" asp-for="Gender">Gender</label>
                        <label>
                            <input asp-for="Gender" type="radio" value="M" /> Male
                        </label>
                        <label>
                            <input asp-for="Gender" type="radio" value="F" /> Female
                        </label>
                    </div>
                </div>
                <div class="col col-6">
                    <div class="form-group">
                        <label class="small" asp-for="BirthDate">Birth of Date</label>
                        <div class='input-group'>
                            <input asp-for="BirthDate" id='birthdate' asp-format="{0:dd/MM/yyyy}" type="date" class="form-control" />
                            <span asp-validation-for="BirthDate" class="text-danger"></span>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group d-none">
                <input asp-for="Picture" required class="form-control" placeholder="Picture" id="Picture" />
                <span asp-validation-for="Picture" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label class="small" asp-for="Description">Description</label>
                <span asp-validation-for="Description" class="text-danger"></span>
                <textarea class="form-control"
                          asp-for="Description"
                          rows="3"
                          cols="20"></textarea>
            </div>


        </div>
        <div class="col col-lg-4 col-md-4 col-sm-6 col-12">
            <h4>Parents <span class="small">(if applicable)</span><i class="fa fa-envelope-o"><!-- empty --></i></h4>
            <div class="row">
                <div class="col col-12">
                    <div class="row">
                        <div class="col col-6">
                            <div class="form-group parent-container">
                                <label class="small">Maternal</label>
                                <select class="form-control" name="MaternalId" id="MaternalId">
                                    <option value="0" selected="selected">
                                        Maternal
                                    </option>
                                    @foreach (GoatDto item in (List
                                <GoatDto>
                                    )ViewData["Maternals"])
                                    {
                                        <option value="@item.Id">@item.Color.Name - @item.Code </option>
                                    }
                                </select>
                                <div class="table">

                                </div>
                            </div>

                        </div>
                        <div class="col col-6">
                            <div class="form-group parent-container">
                                <label class="small">Sire</label>
                                <select class="form-control" name="SireId" id="SireId">
                                    <option value="0" selected="selected">
                                        Sire
                                    </option>
                                    @foreach (GoatDto item in (List
                                 <GoatDto>
                                     )ViewData["Sires"])
                                    {
                                        <option value="@item.Id">@item.Color.Name - @item.Code </option>
                                    }
                                </select>
                                <div class="table">

                                </div>
                            </div>

                        </div>
                    </div>


                    <div class="form-group siblings">
                        <h4>Siblings</h4>
                        <div class="list">
                            <span class="info font-italic small">None</span>
                            <div class="siblings-table"></div>
                        </div>
                    </div>
                </div>
                <div class="col col-12">
                    <h4 class="mt-5">Breeds</h4>
                    <div>
                        TODO:// Breed calculation (manual overrides)
                    </div>
                </div>
            </div>
        </div>
        <div class="col col-lg-4 col-md-4 col-sm-6 col-12 ">
            <div class="row">
                <div class="col col-12 goatImageWrapper">
                    <div class="form-group">
                        <span class="wrapper">
                            <input required type="file" id="goatImage" data-action="/api/image" />
                        </span>
                    </div>
                </div>
            </div>
            <div class="row lineage d-none">
                <div class="col col-12 goatImageWrapper">
                    <div class="form-group">
                        TODO:// Lineage org graph
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col col-lg-4 col-md-4 col-sm-6 col-12">
            <div class="form-group">
                <input type="submit" value="Create" name="Save" class="btn btn-default" id="Submit" />
            </div>
        </div>
    </div>
</form>
@*
    TODO://multiple images per gaots
        https://tutorialzine.com/2013/05/mini-ajax-file-upload-form
*@

@section scripts{
    <script type="text/javascript">
        (function ($) {

            $(document).ready(function () {

                $('#ColorId, #Code').on('change', function (event) {
                    $.ajax({
                        type: "POST",
                        url: '/api/goat/code',
                        data: { colorId: $("#ColorId").val(), code: $("#Code").val() },
                    }).done(function (response) {
                        if (response.error == 0) {
                            $(".code .error").addClass('d-none').removeClass('d-inline-block');
                            $("#Submit").removeAttr("disabled");
                        } else {
                            $(".code .error").removeClass('d-none').addClass('d-inline-block').html(response.response);
                            $("#Submit").attr("disabled", "disabled");
                        }
                    });
                });

                $('#MaternalId, #SireId').on('change', function (event) {
                    // display maternal and paternal
                    // after changing val
                    var parent_container = $('#' + this.id).parents(".parent-container");

                    console.log($('#' + this.id).val());

                    $.ajax({
                        type: "POST",
                        url: '/api/goat',
                        data: { Id: $('#' + this.id).val() },
                    }).done(function (response) {
                        if (response.error == 0) {
                            var table = $('<table  class="table small" />');
                            var row = "";

                            row = $('<tr/>');
                            row.append('<td class="w-25"><img width="100%" src="/images/uploads/' + response.response.picture + '"/><br />Goat Id: ' + response.response.id + '</td>');
                            row.append('<td>Tag Code: <strong>' + response.response.color.name + ' ' + response.response.code + '</strong></td>');
                            table.append(row);

                            $(parent_container).children(".table").html(table);
                        } else {
                            $(parent_container).children(".table").empty();
                        }
                    });

                    // siblings
                    $.ajax({
                        type: "POST",
                        url: '/api/goat/siblings',
                        data: { maternalId: $("#MaternalId").val(), sireId: $("#SireId").val() },
                    }).done(function (response) {
                        if (response.error == 0) {
                            $('.siblings .list .siblings-table').empty();
                            $(".siblings .list .info").addClass("d-none");

                            var div = $('<div class="row small"/>');
                            $(response.goats).each(function () {
                                var inner_div = $('<div class="col col-4 col-xs-6 text-align-center" />');
                                inner_div.append('<img width="auto" height="50px" src="/images/uploads/' + this.picture + '"/><br />Goat Id: ' + this.id);
                                inner_div.append('<br />Tag Code: <strong>' + this.color.name + ' ' + this.code + '</strong>');

                                div.append(inner_div);
                            });

                            $('.siblings .list .siblings-table').html(div);

                        } else {
                            $('.siblings .list .siblings-table').empty();
                            $(".siblings .list .info").removeClass("d-none");
                        }
                    });
                });

                $('#goatImage').on('change', function (event) {
                    event.preventDefault();

                    var $file = $("#goatImage")[0].files[0];

                    var $action = $("#goatImage").data("action");

                    var $formdata = new FormData();

                    $formdata.append("file", $file);

                    $.ajax({
                        type: "POST",
                        url: $action,
                        data: $formdata, // serializes the form's elements.
                        processData: false,
                        contentType: false
                    }).done(function (result) {

                        var img = $('<img />',
                            {
                                width: '100%',
                                id: 'goatImg',
                                src: '/images/uploads/' + result
                            });

                        $("#Picture").val(result);
                        $(".goatImageWrapper .wrapper").html(img);
                    });

                    return false; // avoid to execute the actual submit of the form.
                });
            });
        })(jQuery);
    </script>
}

